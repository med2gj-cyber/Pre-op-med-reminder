<script>
    const urlParams = new URLSearchParams(window.location.search);
    const med = urlParams.get('m') || "ไม่ระบุชื่อยา";
    const dateRaw = urlParams.get('d') || "";

    function acceptConsent() {
        document.getElementById('consentSection').classList.add('hidden');
        document.getElementById('mainSection').classList.remove('hidden');
        document.getElementById('displayMed').innerText = med;
        // ตรวจสอบความยาววันที่และแสดงผลให้ถูกต้อง
        if(dateRaw && dateRaw.length === 8) {
            document.getElementById('displayDate').innerText = `${dateRaw.substring(6,8)}/${dateRaw.substring(4,6)}/${dateRaw.substring(0,4)}`;
        }
    }

    function generateICS() {
        // ตรวจสอบว่ามีข้อมูลวันที่ก่อนทำรายการ
        if (!dateRaw || dateRaw.length !== 8) {
            alert("ไม่พบข้อมูลวันที่ที่ถูกต้อง");
            return;
        }

        const icsMsg = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//Med Reminder//TH",
            "BEGIN:VEVENT",
            `SUMMARY:หยุดยา ${med} (ก่อนผ่าตัด)`,
            `DTSTART;VALUE=DATE:${dateRaw}`,
            `DTEND;VALUE=DATE:${dateRaw}`,
            `DESCRIPTION:กรุณางดทานยา ${med} ตั้งแต่วันนี้เป็นต้นไป เพื่อเตรียมตัวผ่าตัด กรณีเลื่อนนัดกรุณาโทร 02-849-6600`,
            "BEGIN:VALARM",
            "